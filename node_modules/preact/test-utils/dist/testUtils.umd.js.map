{"version":3,"file":"testUtils.umd.js","sources":["../src/index.js"],"sourcesContent":["import { options } from 'preact';\n\n/**\n * Setup a rerender function that will drain the queue of pending renders\n * @returns {() => void}\n */\nexport function setupRerender() {\n\toptions.__test__previousDebounce = options.debounceRendering;\n\toptions.debounceRendering = cb => (options.__test__drainQueue = cb);\n\treturn () => options.__test__drainQueue && options.__test__drainQueue();\n}\n\nconst isThenable = value => value != null && typeof value.then == 'function';\n\n/** Depth of nested calls to `act`. */\nlet actDepth = 0;\n\n/**\n * Run a test function, and flush all effects and rerenders after invoking it.\n *\n * Returns a Promise which resolves \"immediately\" if the callback is\n * synchronous or when the callback's result resolves if it is asynchronous.\n *\n * @param {() => void|Promise<void>} cb The function under test. This may be sync or async.\n * @return {Promise<void>}\n */\nexport function act(cb) {\n\tif (++actDepth > 1) {\n\t\t// If calls to `act` are nested, a flush happens only when the\n\t\t// outermost call returns. In the inner call, we just execute the\n\t\t// callback and return since the infrastructure for flushing has already\n\t\t// been set up.\n\t\t//\n\t\t// If an exception occurs, the outermost `act` will handle cleanup.\n\t\ttry {\n\t\t\tconst result = cb();\n\t\t\tif (isThenable(result)) {\n\t\t\t\treturn result.then(\n\t\t\t\t\t() => {\n\t\t\t\t\t\t--actDepth;\n\t\t\t\t\t},\n\t\t\t\t\te => {\n\t\t\t\t\t\t--actDepth;\n\t\t\t\t\t\tthrow e;\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t--actDepth;\n\t\t\tthrow e;\n\t\t}\n\t\t--actDepth;\n\t\treturn Promise.resolve();\n\t}\n\n\tconst previousRequestAnimationFrame = options.requestAnimationFrame;\n\tconst rerender = setupRerender();\n\n\t/** @type {() => void} */\n\tlet flush, toFlush;\n\n\t// Override requestAnimationFrame so we can flush pending hooks.\n\toptions.requestAnimationFrame = fc => (flush = fc);\n\n\tconst finish = () => {\n\t\ttry {\n\t\t\trerender();\n\t\t\twhile (flush) {\n\t\t\t\ttoFlush = flush;\n\t\t\t\tflush = null;\n\n\t\t\t\ttoFlush();\n\t\t\t\trerender();\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (!err) {\n\t\t\t\terr = e;\n\t\t\t}\n\t\t} finally {\n\t\t\tteardown();\n\t\t}\n\n\t\toptions.requestAnimationFrame = previousRequestAnimationFrame;\n\t\t--actDepth;\n\t};\n\n\tlet err;\n\tlet result;\n\n\ttry {\n\t\tresult = cb();\n\t} catch (e) {\n\t\terr = e;\n\t}\n\n\tif (isThenable(result)) {\n\t\treturn result.then(finish, err => {\n\t\t\tfinish();\n\t\t\tthrow err;\n\t\t});\n\t}\n\n\t// nb. If the callback is synchronous, effects must be flushed before\n\t// `act` returns, so that the caller does not have to await the result,\n\t// even though React recommends this.\n\tfinish();\n\tif (err) {\n\t\tthrow err;\n\t}\n\treturn Promise.resolve();\n}\n\n/**\n * Teardown test environment and reset preact's internal state\n */\nexport function teardown() {\n\tif (options.__test__drainQueue) {\n\t\t// Flush any pending updates leftover by test\n\t\toptions.__test__drainQueue();\n\t\tdelete options.__test__drainQueue;\n\t}\n\n\tif (typeof options.__test__previousDebounce != 'undefined') {\n\t\toptions.debounceRendering = options.__test__previousDebounce;\n\t\tdelete options.__test__previousDebounce;\n\t} else {\n\t\toptions.debounceRendering = undefined;\n\t}\n}\n"],"names":["setupRerender","options","__test__previousDebounce","debounceRendering","cb","__test__drainQueue","isThenable","value","then","actDepth","act","result","e","Promise","resolve","previousRequestAnimationFrame","requestAnimationFrame","rerender","flush","toFlush","fc","finish","err","teardown","undefined"],"mappings":"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"}