{"version":3,"file":"testUtils.js","sources":["../src/index.js"],"sourcesContent":["import { options } from 'preact';\n\n/**\n * Setup a rerender function that will drain the queue of pending renders\n * @returns {() => void}\n */\nexport function setupRerender() {\n\toptions.__test__previousDebounce = options.debounceRendering;\n\toptions.debounceRendering = cb => (options.__test__drainQueue = cb);\n\treturn () => options.__test__drainQueue && options.__test__drainQueue();\n}\n\nconst isThenable = value => value != null && typeof value.then == 'function';\n\n/** Depth of nested calls to `act`. */\nlet actDepth = 0;\n\n/**\n * Run a test function, and flush all effects and rerenders after invoking it.\n *\n * Returns a Promise which resolves \"immediately\" if the callback is\n * synchronous or when the callback's result resolves if it is asynchronous.\n *\n * @param {() => void|Promise<void>} cb The function under test. This may be sync or async.\n * @return {Promise<void>}\n */\nexport function act(cb) {\n\tif (++actDepth > 1) {\n\t\t// If calls to `act` are nested, a flush happens only when the\n\t\t// outermost call returns. In the inner call, we just execute the\n\t\t// callback and return since the infrastructure for flushing has already\n\t\t// been set up.\n\t\t//\n\t\t// If an exception occurs, the outermost `act` will handle cleanup.\n\t\ttry {\n\t\t\tconst result = cb();\n\t\t\tif (isThenable(result)) {\n\t\t\t\treturn result.then(\n\t\t\t\t\t() => {\n\t\t\t\t\t\t--actDepth;\n\t\t\t\t\t},\n\t\t\t\t\te => {\n\t\t\t\t\t\t--actDepth;\n\t\t\t\t\t\tthrow e;\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t--actDepth;\n\t\t\tthrow e;\n\t\t}\n\t\t--actDepth;\n\t\treturn Promise.resolve();\n\t}\n\n\tconst previousRequestAnimationFrame = options.requestAnimationFrame;\n\tconst rerender = setupRerender();\n\n\t/** @type {() => void} */\n\tlet flush, toFlush;\n\n\t// Override requestAnimationFrame so we can flush pending hooks.\n\toptions.requestAnimationFrame = fc => (flush = fc);\n\n\tconst finish = () => {\n\t\ttry {\n\t\t\trerender();\n\t\t\twhile (flush) {\n\t\t\t\ttoFlush = flush;\n\t\t\t\tflush = null;\n\n\t\t\t\ttoFlush();\n\t\t\t\trerender();\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (!err) {\n\t\t\t\terr = e;\n\t\t\t}\n\t\t} finally {\n\t\t\tteardown();\n\t\t}\n\n\t\toptions.requestAnimationFrame = previousRequestAnimationFrame;\n\t\t--actDepth;\n\t};\n\n\tlet err;\n\tlet result;\n\n\ttry {\n\t\tresult = cb();\n\t} catch (e) {\n\t\terr = e;\n\t}\n\n\tif (isThenable(result)) {\n\t\treturn result.then(finish, err => {\n\t\t\tfinish();\n\t\t\tthrow err;\n\t\t});\n\t}\n\n\t// nb. If the callback is synchronous, effects must be flushed before\n\t// `act` returns, so that the caller does not have to await the result,\n\t// even though React recommends this.\n\tfinish();\n\tif (err) {\n\t\tthrow err;\n\t}\n\treturn Promise.resolve();\n}\n\n/**\n * Teardown test environment and reset preact's internal state\n */\nexport function teardown() {\n\tif (options.__test__drainQueue) {\n\t\t// Flush any pending updates leftover by test\n\t\toptions.__test__drainQueue();\n\t\tdelete options.__test__drainQueue;\n\t}\n\n\tif (typeof options.__test__previousDebounce != 'undefined') {\n\t\toptions.debounceRendering = options.__test__previousDebounce;\n\t\tdelete options.__test__previousDebounce;\n\t} else {\n\t\toptions.debounceRendering = undefined;\n\t}\n}\n"],"names":["setupRerender","options","__test__previousDebounce","debounceRendering","cb","__test__drainQueue","isThenable","value","then","actDepth","act","result","e","Promise","resolve","previousRequestAnimationFrame","requestAnimationFrame","rerender","flush","toFlush","fc","finish","err","teardown","undefined"],"mappings":"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"}