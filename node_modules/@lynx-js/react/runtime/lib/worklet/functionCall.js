// Copyright 2025 The Lynx Authors. All rights reserved.
// Licensed under the Apache License Version 2.0 that can be found in the
// LICENSE file in the root directory of this source tree.
import { WorkletEvents } from '@lynx-js/react/worklet-runtime/bindings';
import { destroyTasks } from './destroy.js';
import { IndexMap } from './indexMap.js';
let resolveMap;
function initReturnValueListener() {
    const context = __JS__ ? lynx.getCoreContext() : lynx.getJSContext();
    resolveMap = new IndexMap();
    context.addEventListener(WorkletEvents.FunctionCallRet, onFunctionCallRet);
    destroyTasks.push(() => {
        context.removeEventListener(WorkletEvents.FunctionCallRet, onFunctionCallRet);
        resolveMap = undefined;
    });
}
/**
 * @internal
 */
function onFunctionCall(resolve) {
    if (!resolveMap) {
        initReturnValueListener();
    }
    return resolveMap.add(resolve);
}
function onFunctionCallRet(event) {
    const data = JSON.parse(event.data);
    const resolve = resolveMap.get(data.resolveId);
    resolveMap.remove(data.resolveId);
    resolve(data.returnValue);
}
export { onFunctionCall };
//# sourceMappingURL=functionCall.js.map